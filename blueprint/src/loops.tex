\chapter{Loops}
\label{chap:loops}

\section{Introduction}
\label{sec:loops_introduction}

In this chapter, we explain how to construct families of loops to feed into the
corrugation process explained at the end of the introduction.
A loop is a map defined on the circle $ùïä^1 = ‚Ñù/‚Ñ§$.
It can also freely be seen as $1$-periodic maps defined on $‚Ñù$.

\begin{definition}
  \label{def:average}
  The average of a loop $Œ≥$ is $\bar Œ≥ := \int_{ùïä^1} Œ≥(s)\, ds$.
\end{definition}

Throughout this document, $E$ and $F$ will denote finite-dimensional
real vector spaces.
All of this chapter is devoted to proving the following proposition.

\begin{proposition}
  \label{prop:loops}
  \uses{def:average}
  Let $U$ be an open set in $E$ and $K ‚äÜ U$ a compact subset.
  Let $Œ©$ be a set in $E √ó F$ such that, for each $x$ in $U$,
  $Œ©_x := Œ© ‚à© (\{x\} √ó F)$ is open and connected.

  Let $Œ≤$ and $g$ be maps from $E$ to $F$ that are smooth on $U$.
  Assume that $Œ≤(x) ‚àà Œ©_x$ for all $x$ in $U$,
  and $g(x) = Œ≤(x)$ near $K$.

  If, for every $x$ in $U$, $g(x)$ is in the convex hull of $Œ©_x$, then there
  exists a smooth family of loops
  \[
    Œ≥ \co E √ó [0, 1] √ó ùïä^1 ‚Üí F, (x, t, s) ‚Ü¶ Œ≥^t_x(s)
  \]
  such that, for all $x$ in $U$, and all $(t, s) ‚àà [0, 1] √ó ùïä^1$
  \begin{itemize}
    \item
      $Œ≥^t_x(s) ‚àà Œ©_x$
    \item
      $Œ≥^0_x(s) = Œ≤(x)$
    \item
      $\bar Œ≥^1_x = g(x)$
    \item
      $Œ≥^t_x(s) = Œ≤(x)$ if $x$ is near $K$.
  \end{itemize}
\end{proposition}


Let us briefly sketch the geometric idea behind the above proposition
if we pretend there is only one point $x$, and drop it from the
notation, and also focus only on $Œ≥^1$.
By assumption, there is a finite collection of points $p_i$ in $Œ©$ and $Œª_i ‚àà
[0, 1]$ such that $g$ is the barycenter $\sum Œª_i p_i$. Since $Œ©$ is open and
connected, there is a smooth loop $Œ≥_0$ which goes through each $p_i$. The
claim is that $g$ is the average value of $Œ≥ = Œ≥_0 ‚àò h$ for some
self-diffeomorphism $h$ of $ùïä^1$. The idea is to choose $h$ such that
$Œ≥$ rushes to $p_1$, stays there during a time roughly $Œª_1$, rushes to
$p_2$, etc. But, in order to achieve average exactly $g$, it seems like $h$
needs to be a discontinuous piecewise constant map. The assumption that $g$ is
in the \emph{interior} of the convex hull gives enough slack to get away with
a smooth $h$.  Actually the
conclusion would be false without this interior assumption.

In the previous proof sketch, there is a lot of freedom in constructing $Œ≥$,
which is problematic when trying to do it consistently when $x$ varies.

\section{Preliminaries}
\label{sec:preliminaries}

We'll need the Caratheodory lemma:

\begin{lemma}
\label{lem:caratheodory}
  If a point $x$ of $‚Ñù^d$ lies in the convex hull of a set $P$,
  then $x$ can be written as the convex combination of at most $d + 1$
  points in $P$.
\end{lemma}

\begin{proof}
  TODO\dots
\end{proof}

\begin{lemma}
  \label{lem:int_cvx}
  If a point $x$ of $‚Ñù^d$ lies in the interior of the convex hull of a set $P$,
  then $x$ can be written as the convex combination of at most $d + 1$
  points in $P$ with only positive coefficients.
\end{lemma}

\begin{proof}
  \uses{lem:caratheodory}
  TODO\dots

  Or else replace the assumption of this lemma by its conclusion in
  every definition. This won't change anything since $P$ will always be
  open.
\end{proof}


\begin{lemma}
\label{lem:smooth_convex_hull}
Let $x_0$ be a point in $‚Ñù^d$.
Let $p_0, ‚Ä¶, p_d$ be functions from $‚Ñù^d$ to $‚Ñù^d$ that are smooth near
$x_0$. Assume that $x_0$ is in the interior of the convex hull of
$p_0(x_0), ‚Ä¶, p_d(x_0)$. Then there is a neighborhood $U$ of $x_0$ and
smooth functions $w_0, ‚Ä¶, w_d$ from $U$ to $(0, 1)$ such that
\[
  \sum_i w_i(x)p_i(x) = x \qquad \text{and}\qquad
  \sum_i w_i(x) = 1.
\]
\end{lemma}

\begin{proof}
  TODO\dots using the implicit function theorem.
\end{proof}

\subsection{Surrounding families}
\label{sub:surrounding_families}

It will be convenient to introduce some more vocabulary.

\begin{definition}
  \label{def:surrounds}
  We say a loop $Œ≥$ surrounds a vector $v$ if $v$ is in the interior of
  the convex hull of $Œ≥(ùïä^1)$.
  Also, we fix a base point $0$ in $ùïä^1$ and say a loop is based at some
  point $b$ if $0$ is sent to $b$.
\end{definition}

Constructing \emph{one} such loop is trivial.

\begin{lemma}
  \label{lem:loop_of_hull}
  \uses{def:surrounds}
  If a vector $v$ is in the convex hull of a connected open subset $O$
  then, for every base point $b ‚àà O$, there is a continuous
  family of loops
  $Œ≥ \co [0, 1] √ó ùïä^1 ‚Üí E, (t, s) ‚Ü¶ Œ≥^t(s)$ such that, for all $t$ and
  $s$:
  \begin{itemize}
    \item
      $Œ≥^t$ is based at $b$
    \item
      $Œ≥^0(s) = b$
    \item
      $Œ≥^t(s) ‚àà O$
    \item
      $Œ≥^1$ surrounds $v$
  \end{itemize}
\end{lemma}

\begin{proof}
  \uses{lem:int_cvx}
  Since $O$ is open, its convex hull is its interior convex hull.
  Hence \Cref{lem:int_cvx} gives points $p_i$ in $O$ such that
  $v$ is in the interior of the convex hull of the $p_i$.
  Since $O$ is open and connected, it is path connected.
  Let $Œª \co [0, 1] ‚Üí Œ©_x$ be a continuous path starting at $b$ and
  going through these points.
  We can concatenate $Œª$ and its opposite to get $Œ≥^1$,
  say $Œ≥^1(s) = Œª((1-\cos 2œÄs)/2)$.
  This is a round-trip loop: it back-tracks when it reaches $Œª(1)$
  at $s = 1/2$.
  We then define $Œ≥^t$ as the round-trip that stops at $s = t/2$, stays
  still until $s = 1-t/2$ and then backtracks.
\end{proof}


The first main task in proving Proposition~\ref{prop:loops} is to construct
suitable families of loops $Œ≥_x$ surrounding $g(x)$, by assembling local
families of loops.
Those will then be reparametrized to get the correct average in the next
section.
In this section, we will work only with \emph{continuous} loops.
This will make constructions easier and we will smooth those loops
in the end, taking advantage of the fact that $Œ©$ and the surrounding
condition are open.

\begin{definition}
  \label{def:family_surrounds}
  \uses{def:surrounds}
  A continuous family of loops $Œ≥ \co E √ó [0, 1] √ó ùïä^1 ‚Üí F, (x, t, s) ‚Ü¶ Œ≥^t_x(s)$
  surrounds a map $g \co E ‚Üí F$ with base $Œ≤ \co E ‚Üí F$
  on $U ‚äÜ E$ if, for every $x$ in $U$, every $t ‚àà [0, 1]$ and every
  $s ‚àà ùïä^1$,
  \begin{itemize}
    \item
      $Œ≥^t_x$ is based at $Œ≤(x)$
    \item
      $Œ≥^0_x(s) = Œ≤(x)$
    \item
      $Œ≥^1_x$ surrounds $g(x)$.
  \end{itemize}
  The space of such families will be denoted by
  $\Loop(g, Œ≤, U)$.
\end{definition}

Families of surrounding loops are easy to construct locally.

\begin{lemma}
  \label{lem:local_loops}
  \uses{def:family_surrounds}
  Assume $Œ©$ is open and connected over some neighborhood of $x_0$.
  If $g(x)$ is the convex hull of $Œ©_x$ for $x$ near $x_0$ then there is
  a continuous family of loops defined near $x_0$, based at $Œ≤$,
  taking value in $Œ©$ and surrounding $g$.
\end{lemma}

\begin{proof}
  \uses{lem:loop_of_hull}
  In this proof we don't mention the $t$ parameter since it plays no
  role, but it is still there.
  \Cref{lem:loop_of_hull} gives a loop $Œ≥$ based at $Œ≤(x_0)$,
  taking values in $Œ©_{x_0}$ and surrounding $g(x_0)$.
  Since $g(x_0)$ is in the interior of the convex hull of $\im Œ≥$,
  we can set $Œ≥_x(s) = Œ≤(x) + (Œ≥(s) - Œ≤(x_0))$.
  It takes values in $Œ©$ because the later is open near $x_0$.
\end{proof}

The difficulty in constructing global families of surrounding loops is that
there are plenty of surrounding loops and we need to choose them
consistently.
The key feature of the above definition is that the $t$ parameter not only
allows us to cut out the corrugation
process in the next chapter, but also brings a ``satisfied or refund'' guarantee,
as explained in the next lemma.

\begin{lemma}
  \label{lem:satisfied_or_refund}
  \uses{def:family_surrounds}
  Each $L(g, Œ≤, U)$ is path connected:
  for every $Œ≥_0$ and $Œ≥_1$ in $\Loop(g, Œ≤, U)$,
  there is a continuous map
  $Œ≥ \co [0, 1] √ó E √ó [0, 1] √ó ùïä^1 ‚Üí F, (œÑ, x, t, s) ‚Ü¶ Œ≥^t_{œÑ, x}(s)$
  which interpolates between $Œ≥_0$ and $Œ≥_1$ in
  $L(g, Œ≤, U)$.
\end{lemma}

\begin{proof}
  Let $œÅ$ be the piecewise affine map from $‚Ñù$ to $‚Ñù$ such that
  $œÅ(œÑ) = 1$ if $œÑ ‚â§ 1/2$, $œÅ$ is affine on $[1/2, 1]$,
  $œÅ(œÑ) = 0$ if $œÑ ‚â• 1$.
  We set
  \[
    Œ≥_{œÑ, x}^t(s) =
    \begin{cases}
      Œ≥_{0, x}^{œÅ(œÑ)t}\left(\frac1{1 - œÑ} s\right) & \text{if $s < 1 - œÑ$ and $œÑ < 1$}\\
      Œ≤(x)                & \text{if $s = 1 - œÑ$}\\
      Œ≥_{1, x}^{œÅ(1-œÑ)t}\left(\frac1œÑ \big(s - (1- œÑ)\big)\right) & \text{if $s > 1 - œÑ$ and $œÑ > 0$}\\
    \end{cases}
  \]
  There is no surprise and no fun in checking that this is a
  well-defined continuous homotopy of families of loops based at $Œ≤$
  interpolating between $Œ≥_0$ and $Œ≥_1$.

  The beautiful observation motivating the above formula is why each
  $Œ≥^1_{œÑ, x}$ surrounds $g(x)$.
  The key is that the image of $Œ≥^1_{œÑ, x}$ contains the image of
  $Œ≥^1_{0, x}$ when $œÑ ‚â§ 1/2$, and contains  the image of
  $Œ≥^1_{1, x}$ when $œÑ ‚â• 1/2$.
  Hence the interior of the convex hull of the image always contains
  $g(x)$.
\end{proof}

\begin{corollary}
  \label{cor:extend_loops}
  \uses{def:family_surrounds}
  Let $U_0$ and $U_1$ be open sets in $E$.
  Let $K_0 ‚äÜ U_0$ and $K_1 ‚äÜ U_1$ be compact subsets.
  For any $Œ≥_0 ‚àà \Loop(U_0, g, Œ≤)$ and $Œ≥_1 ‚àà \Loop(U_1, g, Œ≤)$,
  there exists $U ‚àà ùìù(K_0 ‚à™ K_1)$ and
  there exists $Œ≥ ‚àà \Loop(U, g, Œ≤)$
  which coincides with $Œ≥_0$ near $K_0$.
\end{corollary}

\begin{proof}
  \uses{lem:satisfied_or_refund}
  Let $U_0'$ be an open neighborhood of $K_0$ whose closure
  $\bar U_0'$ is compact in $U_0$.
  Since $\bar U_0'$ and $K_1' := K_1 ‚àñ (K_1 ‚à© U_0)$
  are disjoint compact subsets of $E$, there is some continuous cut-off
  $œÅ \co E ‚Üí [0, 1]$ which vanishes on $U_0'$ and equals one on some
  neighborhood $U_1'$ of $K_1'$.

  Lemma~\ref{lem:satisfied_or_refund} gives a homotopy of loops
  $Œ≥_œÑ$ from $Œ≥_0$ to $Œ≥_1$ on $U_0 ‚à© U_1$.
  On $U_0' ‚à™ (U_0 ‚à© U_1) ‚à™ U_1'$, which is a
  neighborhood of $K_0 ‚à™ K_1$, we set
  \[
      Œ≥_x =
      \begin{cases}
        Œ≥_{0, x}       & \text{for $x ‚àà U_0'$} \\
        Œ≥_{œÅ(x), x} & \text{for $x ‚àà U_0 ‚à© U_1$} \\
        Œ≥_{1, x}       & \text{for $x ‚àà U_1'$}
      \end{cases}
  \]
  which has the required properties.
\end{proof}


\begin{lemma}
  \label{lem:‚àÉ_surrounding_loops}
  In the setup of Proposition~\ref{prop:loops}, assume we have a
  continuous family $Œ≥$ of loops defined near $K$ which is based at $Œ≤$,
  surrounds $g$ and such that each $Œ≥_x^1$ takes values in $Œ©_x$.
  Then there such a family which is defined on all of $U$ and agrees
  with $Œ≥$ near $K$.
\end{lemma}

\begin{proof}
  \uses{lem:loop_of_hull, lem:local_loops, cor:extend_loops}
  Let $U_0$ be an open set containing $K$ and
  contained in the domain of $Œ≥$. Let $U_0'$ be an open neighborhood of $K$
  with compact closure in $U_0$. Let $U_i$, $i ‚â• 1$ be a local finite covering of
  $U ‚àñ U_0'$ by open subsets not intersecting $K$ and where the preceding
  observations gives families of loops $Œ≥^i$. We also set $Œ≥^0 = \rst{Œ≥}{U_0}$.
  In particular the open sets $U_i$, $i ‚â• 0$ cover the whole of $U$, and only
  $U_0$ intersects $K$. Let $K_i$, $0 ‚â§ i ‚â§ N$, be a family of compact sets with
  $K_i ‚äÇ U_i$ which covers $U$. We repeatedly apply
  Corollary~\ref{cor:extend_loops} to $K_i$ and $K_{i+1}$, in this order, to
  get a family $Œ≥'$ defined over all $U$. Since each step preserves the
  family on $\Op{K_i}$ and only $U_0$ intersects (in fact contains) $K$, we do
  have $Œ≥' = Œ≥$ on $\Op{K}$.
\end{proof}

\subsection{The reparametrization lemma}
\label{sub:the_reparametrization_lemma}

The second ingredient needed to prove Proposition~\ref{prop:loops} is a
parametric reparametrization lemma.

\begin{lemma}
\label{lem:reparametrization}
Let $Œ≥ : X √ó ùïä^1 ‚Üí E$ be a family of loops in a vector bundle $E ‚Üí X$ (ie. each
$Œ≥_x$ is a loop in $E_x$) and let $g$ be a section of $E$. If
$Œ≥_x$ strictly  surrounds $g(x)$ for all $x$, and $Œ≥_x$ has average $g(x)$ when
$x$ is outside some compact subset of $X$, then there is a family of circle
diffeomorphisms $h : X √ó ùïä^1 ‚Üí ùïä^1$ such that each $Œ≥_x ‚àò h_x$ has average $g(x)$.
\end{lemma}

\begin{proof}
  \uses{lem:caratheodory, lem:int_cvx, lem:smooth_convex_hull}
  For any fixed $x$, since $Œ≥_x$ strictly surrounds $g(x)$, there are points
  $s_1, ‚Ä¶, s_{n+1}$ in $ùïä^1$ such that $g(x)$ is in the interior of the simplex
  spanned by the corresponding points $Œ≥_x(s_j)$, by
  \Cref{lem:caratheodory}.
  Let $Œº_1, ‚Ä¶, Œº_{n+1}$ be smooth positive probability measures very
  close to the Dirac measures on $s_j$ (ie. $Œº_j = f_j\, ds$ for some
  smooth positive function $f_j$ and, for any function $h$,
  $\int h\,dŒº_j$ is almost $h(s_j)$).  We set $p_j = \int Œ≥_x\, d\mu_j$, which
  is almost $Œ≥_x(s_j)$ so that $g(x) = \sum w_j p_j$ for some weights
  $w_j$ in the open interval $(0, 1)$ according to \Cref{lem:int_cvx}.

  If $x'$ is in a sufficiently small neighborhood of $x$, $g(x')$ is in
  the interior of the simplex spanned by
  $p_j(x') := \int Œ≥_{x'}\, d\mu_j$.
  In such a neighborhood, \Cref{lem:smooth_convex_hull} gives
  smooth weight functions $w_j$
  such that $g(x') = \sum w_j(x')p_j(x')$.
  Let $U^i$, $i ‚â• 1$ be a locally finite cover of $U$ by such
  neighborhoods, with corresponding measures $Œº_j^i$, moving points
  $p_j^i$ and weight functions $w_j^i$.
  Let $(œÅ_i)$ be a partition of unity associated to this covering. For
  every $x$, we set
  \[
    Œº_x = \sum_{i=1}^‚àû \sum_{j=1}^{n+1} œÅ_i(x)w_j^i(x)\, Œº_j^i
  \]
  so that:
  \begin{align*}
    \int Œ≥_x\, dŒº_x &=
    \sum_i œÅ_i(x)\sum_{j=1}^{n+1} w_j^i(x) \int Œ≥_x\, dŒº_j^i\\
    &= \sum_i œÅ_i(x)\sum_{j=1}^{n+1} w_j^i(x) p_j^i(x)\\
    &= \sum_i œÅ_i(x) g(x) = g(x).
  \end{align*}
  We now set $h_x^{-1}(t) = \int_0^tdŒº_x$ so that
  $g(x) = \overline{Œ≥_x ‚àò h_x}$ for all $x$.
\end{proof}

\subsection{Proof of the loop construction proposition}
\label{sub:proof_of_the_loop_construction_proposition}

We finally assemble the ingredients from the previous two sections.

\begin{proof}[Proof of Proposition~\ref{prop:loops}]
  \proves{prop:loops}
  \uses{lem:‚àÉ_surrounding_loops, lem:reparametrization}
  Let $Œ≥^*$ be a family of loops surrounding the origin in $F$,
  constructed using \Cref{lem:local_loops}.
  For $x$ in some neighborhood $U^*$ of $K$ where $g = Œ≤$, we set
  $Œ≥_x = g(x) + ŒµŒ≥^*$ where $Œµ > 0$ is sufficiently small to ensure
  the image of $Œ≥_x$ and its convex hull are contained in $Œ©_x$ (recall $Œ©$ is
  open and $K$ is compact).
  Lemma~\ref{lem:‚àÉ_surrounding_loops} extends this family to a continuous
  family of surrounding loops $Œ≥_x$ for all $x$ (this is not yet our
  final $Œ≥$).

  We then need to approximate this continuous family by a smooth one.
  Some care is needed to ensure that it stays based at $Œ≤$.
  For instance, we can first compose each loop by some fixed surjective
  continuous map from $ùïä^1$ to itself that sends a neighborhood of $0$
  to $0$.
  This way each loop becomes constant near $0$, and a convolution
  smoothing will then keep the value at $0$.
  If the smoothing is sufficiently $C^0$ small then the new $Œ≥$ is
  still surrounding and takes values in $Œ©$.

  Then Lemma~\ref{lem:reparametrization} gives a family of circle
  diffeomorphisms $h_x$ such that $Œ≥_x ‚àò h_x$ has average $g(x)$.

  Finally we choose a cut-off function function $œá$ which vanishes on
  $\Op{K}$ and equals one on $\Op{U ‚àñ U^*}$.  In $U^*$, we replace
  $Œ≥_x ‚àò h_x = g(x) + Œ≥^* ‚àò h_x$ by $g(x) + œá(x)Œ≥^* ‚àò h_x$. This
  operation does not change the average values of these loops, because
  it rescales them around their average value, but makes them constant
  on $\Op{K}$. Also, those loops stay in $Œ©$, thanks to our choice of $Œµ$.
\end{proof}

% vim: set expandtab sw=2 tabstop=2:
